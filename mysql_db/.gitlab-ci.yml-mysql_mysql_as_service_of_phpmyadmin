# Gera imagem do banco de dados mysql e a sobre para o repositorio do Gitlab
# com o gitlab-runner executor SHELL, não é necessária nenhuma imagem Docker no pipeline

variables:
    MYSQL_DATABASE: ifmt_db
    #MYSQL_ROOT_PASSWORD: ifmt2   # definido com variavel interna
    DOCKER_NET: db
    MYSQL_CONTAINER_NAME: meu-mysql
    MYSQL_CLIENT_CONTAINER_NAME: meu-phpMyadmin
stages:
    - construcao

criacao-imagem:
    stage: construcao
        services:
        - name: docker:26.1.3-dind  
          alias: docker

    image: docker
    variables:
        DOCKER_TLS_CERTDIR: "/certs"
    script:
        - # construcao da imagem
        - echo "criando a imagem do mysql cliente:- phpMyadmin"
        - docker build -t $CI_REGISTRY/devops/db-mysql:phpMyadmin ./phpMyadmin 
        - echo "Imagem phpMyadmin construida!!!" 

        - echo "Acessando o repositorio !!!" 
        - docker login -u  $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
        - echo "Logged in!!!"
        - # entrega da imagem no repositorio Docker
        - docker push $CI_REGISTRY/devops/db-mysql:phpMyadmin 
        - echo "Imagem  phpMyadmin no repositorio+++! "